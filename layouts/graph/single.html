{{ define "main" }}
{{- /*
  Full-Page Graph View - Interactive knowledge graph

  Features:
  - Full viewport graph
  - Filter by section
  - Filter by note type
  - Search to highlight nodes
  - Toggle link types (direct vs tag-based)
  - Zoom and pan controls
*/ -}}

<div class="graph-page">
  <header class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">{{ .Title }}</h1>
    {{ with .Params.description }}
    <p class="text-gray-600 dark:text-gray-400">{{ . }}</p>
    {{ end }}
  </header>

  {{- /* Controls */ -}}
  <div class="graph-controls mb-4 flex flex-wrap gap-4 items-center text-sm">
    {{- /* Search */ -}}
    <div class="flex items-center gap-2">
      <label for="graph-search" class="text-gray-600 dark:text-gray-400">{{ i18n "search" }}:</label>
      <input type="text" id="graph-search" placeholder="{{ i18n "searchPlaceholder" | default "Search notes..." }}"
        class="px-3 py-1.5 border border-gray-300 dark:border-gray-600 rounded bg-white dark:bg-gray-800 text-gray-900 dark:text-white focus:ring-2 focus:ring-blue-500 focus:border-transparent">
    </div>

    {{- /* Section filter */ -}}
    <div class="flex items-center gap-2">
      <span class="text-gray-600 dark:text-gray-400">{{ i18n "sections" | default "Sections" }}:</span>
      <div class="flex gap-2">
        {{ $sections := slice "articles" "notes" "projects" }}
        {{ range $sections }}
        <label class="flex items-center gap-1 cursor-pointer">
          <input type="checkbox" class="section-filter rounded" value="{{ . }}" checked>
          <span class="capitalize">{{ . }}</span>
        </label>
        {{ end }}
      </div>
    </div>

    {{- /* Link type toggle */ -}}
    <div class="flex items-center gap-2">
      <span class="text-gray-600 dark:text-gray-400">{{ i18n "links" | default "Links" }}:</span>
      <label class="flex items-center gap-1 cursor-pointer">
        <input type="checkbox" id="show-direct-links" checked>
        <span class="text-blue-600 dark:text-blue-400">{{ i18n "directLinks" | default "Direct" }}</span>
      </label>
      <label class="flex items-center gap-1 cursor-pointer">
        <input type="checkbox" id="show-tag-links" checked>
        <span class="text-gray-500">{{ i18n "tagLinks" | default "Tags" }}</span>
      </label>
    </div>

    {{- /* Zoom controls */ -}}
    <div class="flex items-center gap-2 ml-auto">
      <button id="zoom-in" class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700">+</button>
      <button id="zoom-out" class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700">-</button>
      <button id="zoom-reset" class="px-2 py-1 border border-gray-300 dark:border-gray-600 rounded hover:bg-gray-100 dark:hover:bg-gray-700">{{ i18n "reset" | default "Reset" }}</button>
    </div>
  </div>

  {{- /* Graph container */ -}}
  <div id="full-graph" class="border border-gray-200 dark:border-gray-700 rounded-lg bg-gray-50 dark:bg-gray-800 overflow-hidden" style="height: calc(100vh - 280px); min-height: 500px;">
    <div id="graph-loading" class="flex items-center justify-center h-full text-gray-500 dark:text-gray-400">
      Loading graph...
    </div>
  </div>

  {{- /* Node info panel */ -}}
  <div id="node-info" class="hidden mt-4 p-4 border border-gray-200 dark:border-gray-700 rounded-lg bg-white dark:bg-gray-800">
    <div class="flex justify-between items-start">
      <div>
        <h3 id="node-title" class="text-lg font-semibold text-gray-900 dark:text-white"></h3>
        <p id="node-section" class="text-sm text-gray-500 dark:text-gray-400"></p>
      </div>
      <a id="node-link" href="#" class="text-blue-600 dark:text-blue-400 hover:underline">{{ i18n "viewPage" | default "View Page" }} &rarr;</a>
    </div>
    <div id="node-connections" class="mt-2 text-sm text-gray-600 dark:text-gray-300"></div>
  </div>

  {{- /* Legend */ -}}
  <div class="mt-4 flex flex-wrap gap-4 text-sm text-gray-600 dark:text-gray-400">
    <div class="flex items-center gap-2">
      <span class="w-4 h-0.5 bg-blue-500"></span>
      <span>{{ i18n "directLink" | default "Direct wikilink" }}</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-4 h-0.5 bg-gray-400 border-dashed border-t-2 border-gray-400"></span>
      <span>{{ i18n "sharedTag" | default "Shared tag" }}</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-blue-500"></span>
      <span>{{ i18n "articles" | default "Articles" }}</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-green-500"></span>
      <span>{{ i18n "notes" | default "Notes" }}</span>
    </div>
    <div class="flex items-center gap-2">
      <span class="w-3 h-3 rounded-full bg-purple-500"></span>
      <span>{{ i18n "projects" | default "Projects" }}</span>
    </div>
  </div>
</div>

{{- /* Include D3.js */ -}}
<script src="https://cdn.jsdelivr.net/npm/d3@7"></script>

{{- /* Build page lookup maps */ -}}
{{- $pagesByTitle := dict -}}
{{- $pagesByFilename := dict -}}
{{- $pagesById := dict -}}
{{- $pagesByAlias := dict -}}

{{- range .Site.RegularPages -}}
  {{- $pagesByTitle = merge $pagesByTitle (dict .Title .RelPermalink) -}}
  {{- if .File -}}
    {{- $filename := path.Base .File.Path | strings.TrimSuffix ".md" -}}
    {{- $pagesByFilename = merge $pagesByFilename (dict $filename .RelPermalink) -}}
  {{- end -}}
  {{- with .Params.id -}}
    {{- $pagesById = merge $pagesById (dict (string .) $.RelPermalink) -}}
  {{- end -}}
  {{- with .Params.aliases -}}
    {{- range . -}}
      {{- $pagesByAlias = merge $pagesByAlias (dict . $.RelPermalink) -}}
    {{- end -}}
  {{- end -}}
{{- end -}}

<script>
(function() {
  // Full graph data from Hugo
  const graphData = {
    nodes: [
      {{- range $index, $page := .Site.RegularPages -}}
      {{- if $index }},{{ end -}}
      {
        "id": "{{ $page.RelPermalink }}",
        "title": "{{ $page.Title | htmlUnescape | safeJS }}",
        "section": "{{ $page.Section }}",
        "type": "{{ $page.Params.type | default "" }}",
        "tags": [{{- range $i, $t := ($page.Params.tags | default slice) }}{{ if $i }},{{ end }}"{{ $t }}"{{ end -}}]
      }
      {{- end -}}
    ],
    links: [
      {{- $first := true -}}
      {{- $seenLinks := slice -}}

      {{- /* Extract direct wikilinks */ -}}
      {{- range $page := .Site.RegularPages -}}
        {{- $content := $page.RawContent -}}
        {{- $sourcePermalink := $page.RelPermalink -}}

        {{- $bracketMatches := findRE `\[\[([^\]|]+)` $content -}}
        {{- range $bracketMatches -}}
          {{- $linkTarget := replaceRE `^\[\[` "" . -}}
          {{- $targetPermalink := "" -}}

          {{- if hasPrefix $linkTarget "id:" -}}
            {{- $id := strings.TrimPrefix "id:" $linkTarget -}}
            {{- range $.Site.RegularPages -}}
              {{- if eq (string .Params.id) $id -}}
                {{- $targetPermalink = .RelPermalink -}}
              {{- end -}}
            {{- end -}}
          {{- else -}}
            {{- with index $pagesByTitle $linkTarget }}{{ $targetPermalink = . }}{{ end -}}
            {{- if not $targetPermalink }}{{ with index $pagesByFilename $linkTarget }}{{ $targetPermalink = . }}{{ end }}{{ end -}}
            {{- if not $targetPermalink }}{{ with index $pagesByAlias $linkTarget }}{{ $targetPermalink = . }}{{ end }}{{ end -}}
          {{- end -}}

          {{- if and $targetPermalink (ne $sourcePermalink $targetPermalink) -}}
            {{- $linkKey := printf "%s|%s|link" $sourcePermalink $targetPermalink -}}
            {{- if not (in $seenLinks $linkKey) -}}
              {{- $seenLinks = $seenLinks | append $linkKey -}}
              {{- if not $first }},{{ end }}{{ $first = false -}}
              {"source": {{ $sourcePermalink | jsonify }}, "target": {{ $targetPermalink | jsonify }}, "type": "link"}
            {{- end -}}
          {{- end -}}
        {{- end -}}

        {{- $shortcodeMatches := findRE `\{\{<\s*wikilink\s+"([^"]+)"` $content -}}
        {{- range $shortcodeMatches -}}
          {{- $linkTarget := replaceRE `^.*"([^"]+)".*$` "$1" . -}}
          {{- $targetPermalink := "" -}}
          {{- with index $pagesByTitle $linkTarget }}{{ $targetPermalink = . }}{{ end -}}
          {{- if not $targetPermalink }}{{ with index $pagesByFilename $linkTarget }}{{ $targetPermalink = . }}{{ end }}{{ end -}}

          {{- if and $targetPermalink (ne $sourcePermalink $targetPermalink) -}}
            {{- $linkKey := printf "%s|%s|link" $sourcePermalink $targetPermalink -}}
            {{- if not (in $seenLinks $linkKey) -}}
              {{- $seenLinks = $seenLinks | append $linkKey -}}
              {{- if not $first }},{{ end }}{{ $first = false -}}
              {"source": {{ $sourcePermalink | jsonify }}, "target": {{ $targetPermalink | jsonify }}, "type": "link"}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}

      {{- /* Tag-based connections */ -}}
      {{- range $page := .Site.RegularPages -}}
        {{- range $tag := $page.GetTerms "tags" -}}
          {{- range $otherPage := $.Site.RegularPages -}}
            {{- if ne $page.RelPermalink $otherPage.RelPermalink -}}
              {{- range $otherTag := $otherPage.GetTerms "tags" -}}
                {{- if eq $tag.LinkTitle $otherTag.LinkTitle -}}
                  {{- $linkKey := printf "%s|%s|tag" $page.RelPermalink $otherPage.RelPermalink -}}
                  {{- $reverseLinkKey := printf "%s|%s|tag" $otherPage.RelPermalink $page.RelPermalink -}}
                  {{- if not (or (in $seenLinks $linkKey) (in $seenLinks $reverseLinkKey)) -}}
                    {{- $seenLinks = $seenLinks | append $linkKey -}}
                    {{- if not $first }},{{ end }}{{ $first = false -}}
                    {"source": {{ $page.RelPermalink | jsonify }}, "target": {{ $otherPage.RelPermalink | jsonify }}, "type": "tag", "tag": {{ $tag.LinkTitle | jsonify }}}
                  {{- end -}}
                {{- end -}}
              {{- end -}}
            {{- end -}}
          {{- end -}}
        {{- end -}}
      {{- end -}}
    ]
  };

  // Deduplicate links
  const seenLinks = new Map();
  graphData.links.forEach(link => {
    const key = [link.source, link.target].sort().join('|');
    const existing = seenLinks.get(key);
    if (!existing || (link.type === 'link' && existing.type === 'tag')) {
      seenLinks.set(key, link);
    }
  });
  graphData.links = Array.from(seenLinks.values());

  // State
  let currentZoom = d3.zoomIdentity;
  let simulation, svg, node, link, zoom;
  let visibleSections = new Set(['articles', 'notes', 'projects']);
  let showDirectLinks = true;
  let showTagLinks = true;
  let searchTerm = '';

  function initGraph() {
    const container = document.getElementById('full-graph');
    const loading = document.getElementById('graph-loading');

    if (!container || graphData.nodes.length === 0) {
      if (loading) loading.textContent = 'No content to display';
      return;
    }

    const width = container.clientWidth;
    const height = container.clientHeight;

    if (loading) loading.remove();

    const isDark = document.documentElement.classList.contains('dark');
    const colors = {
      node: isDark ? '#60a5fa' : '#2563eb',
      linkDirect: isDark ? '#60a5fa' : '#3b82f6',
      linkTag: isDark ? '#4b5563' : '#d1d5db',
      text: isDark ? '#e5e7eb' : '#374151',
      highlight: '#fbbf24'
    };

    const sectionColors = {
      articles: '#3b82f6',
      notes: '#10b981',
      projects: '#8b5cf6'
    };

    svg = d3.select(container)
      .append('svg')
      .attr('width', width)
      .attr('height', height);

    const g = svg.append('g');

    zoom = d3.zoom()
      .scaleExtent([0.1, 4])
      .on('zoom', (event) => {
        currentZoom = event.transform;
        g.attr('transform', event.transform);
      });

    svg.call(zoom);

    simulation = d3.forceSimulation(graphData.nodes)
      .force('link', d3.forceLink(graphData.links).id(d => d.id).distance(100))
      .force('charge', d3.forceManyBody().strength(-300))
      .force('center', d3.forceCenter(width / 2, height / 2))
      .force('collision', d3.forceCollide().radius(40));

    link = g.append('g')
      .selectAll('line')
      .data(graphData.links)
      .join('line')
      .attr('stroke', d => d.type === 'link' ? colors.linkDirect : colors.linkTag)
      .attr('stroke-opacity', d => d.type === 'link' ? 0.8 : 0.4)
      .attr('stroke-width', d => d.type === 'link' ? 2 : 1)
      .attr('stroke-dasharray', d => d.type === 'link' ? null : '4,4');

    node = g.append('g')
      .selectAll('g')
      .data(graphData.nodes)
      .join('g')
      .attr('cursor', 'pointer')
      .call(d3.drag()
        .on('start', dragstarted)
        .on('drag', dragged)
        .on('end', dragended));

    node.append('circle')
      .attr('r', 8)
      .attr('fill', d => sectionColors[d.section] || colors.node)
      .attr('stroke', '#fff')
      .attr('stroke-width', 2);

    node.append('text')
      .text(d => d.title.length > 25 ? d.title.substring(0, 25) + '...' : d.title)
      .attr('x', 12)
      .attr('y', 4)
      .attr('font-size', '11px')
      .attr('fill', colors.text)
      .attr('pointer-events', 'none');

    node.on('mouseover', function(event, d) {
      d3.select(this).select('circle').transition().duration(200).attr('r', 12);
      showNodeInfo(d);
    }).on('mouseout', function(event, d) {
      d3.select(this).select('circle').transition().duration(200).attr('r', 8);
    }).on('click', function(event, d) {
      window.location.href = d.id;
    });

    simulation.on('tick', () => {
      link
        .attr('x1', d => d.source.x)
        .attr('y1', d => d.source.y)
        .attr('x2', d => d.target.x)
        .attr('y2', d => d.target.y);
      node.attr('transform', d => `translate(${d.x},${d.y})`);
    });

    function dragstarted(event) {
      if (!event.active) simulation.alphaTarget(0.3).restart();
      event.subject.fx = event.subject.x;
      event.subject.fy = event.subject.y;
    }

    function dragged(event) {
      event.subject.fx = event.x;
      event.subject.fy = event.y;
    }

    function dragended(event) {
      if (!event.active) simulation.alphaTarget(0);
      event.subject.fx = null;
      event.subject.fy = null;
    }

    // Setup controls
    setupControls();
  }

  function showNodeInfo(d) {
    const panel = document.getElementById('node-info');
    const title = document.getElementById('node-title');
    const section = document.getElementById('node-section');
    const link = document.getElementById('node-link');
    const connections = document.getElementById('node-connections');

    title.textContent = d.title;
    section.textContent = d.section + (d.type ? ' / ' + d.type : '');
    link.href = d.id;

    const inLinks = graphData.links.filter(l => l.target.id === d.id || l.target === d.id);
    const outLinks = graphData.links.filter(l => l.source.id === d.id || l.source === d.id);
    connections.textContent = `${inLinks.length} incoming, ${outLinks.length} outgoing connections`;

    panel.classList.remove('hidden');
  }

  function setupControls() {
    // Search
    document.getElementById('graph-search').addEventListener('input', (e) => {
      searchTerm = e.target.value.toLowerCase();
      updateVisibility();
    });

    // Section filters
    document.querySelectorAll('.section-filter').forEach(checkbox => {
      checkbox.addEventListener('change', (e) => {
        if (e.target.checked) {
          visibleSections.add(e.target.value);
        } else {
          visibleSections.delete(e.target.value);
        }
        updateVisibility();
      });
    });

    // Link type toggles
    document.getElementById('show-direct-links').addEventListener('change', (e) => {
      showDirectLinks = e.target.checked;
      updateVisibility();
    });

    document.getElementById('show-tag-links').addEventListener('change', (e) => {
      showTagLinks = e.target.checked;
      updateVisibility();
    });

    // Zoom controls
    document.getElementById('zoom-in').addEventListener('click', () => {
      svg.transition().call(zoom.scaleBy, 1.5);
    });

    document.getElementById('zoom-out').addEventListener('click', () => {
      svg.transition().call(zoom.scaleBy, 0.67);
    });

    document.getElementById('zoom-reset').addEventListener('click', () => {
      svg.transition().call(zoom.transform, d3.zoomIdentity);
    });
  }

  function updateVisibility() {
    node.style('opacity', d => {
      const sectionVisible = visibleSections.has(d.section);
      const matchesSearch = !searchTerm || d.title.toLowerCase().includes(searchTerm);
      return sectionVisible && matchesSearch ? 1 : 0.1;
    });

    link.style('opacity', d => {
      const sourceNode = typeof d.source === 'object' ? d.source : graphData.nodes.find(n => n.id === d.source);
      const targetNode = typeof d.target === 'object' ? d.target : graphData.nodes.find(n => n.id === d.target);

      const typeVisible = (d.type === 'link' && showDirectLinks) || (d.type === 'tag' && showTagLinks);
      const sourceVisible = visibleSections.has(sourceNode?.section);
      const targetVisible = visibleSections.has(targetNode?.section);

      return typeVisible && sourceVisible && targetVisible ? (d.type === 'link' ? 0.8 : 0.4) : 0.05;
    });
  }

  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initGraph);
  } else {
    initGraph();
  }
})();
</script>
{{ end }}
