{{ define "main" }}
<div class="space-y-8">
  <header>
    <h1 class="text-4xl font-bold text-gray-900 dark:text-white">{{ .Title }}</h1>
  </header>

  {{- /* Search input */ -}}
  <div class="relative">
    <input
      type="text"
      id="search-input"
      placeholder="Type to search..."
      class="w-full px-4 py-3 text-lg bg-white dark:bg-gray-800 border border-gray-200 dark:border-gray-700 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
      autofocus
    >
    <svg class="absolute right-4 top-1/2 transform -translate-y-1/2 w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
    </svg>
  </div>

  {{- /* Search results */ -}}
  <div id="search-results" class="space-y-4"></div>
</div>

{{- /* Fuse.js for fuzzy search */ -}}
<script src="https://cdn.jsdelivr.net/npm/fuse.js@7.0.0"></script>

<script>
(function() {
  let fuse = null;
  const searchInput = document.getElementById('search-input');
  const searchResults = document.getElementById('search-results');

  // Load search index
  fetch('{{ "index.json" | relURL }}')
    .then(response => response.json())
    .then(data => {
      const options = {
        keys: ['title', 'contents', 'tags', 'section'],
        includeScore: true,
        threshold: 0.3,
        ignoreLocation: true,
      };
      fuse = new Fuse(data, options);
    });

  // Search handler
  searchInput.addEventListener('input', function() {
    const query = this.value.trim();

    if (!query || !fuse) {
      searchResults.innerHTML = '';
      return;
    }

    const results = fuse.search(query, { limit: 20 });

    if (results.length === 0) {
      searchResults.innerHTML = '<p class="text-gray-500 dark:text-gray-400">No results found.</p>';
      return;
    }

    searchResults.innerHTML = results.map(result => {
      const item = result.item;
      return `
        <article class="group">
          <a href="${item.permalink}" class="block p-4 -mx-4 rounded-lg hover:bg-gray-50 dark:hover:bg-gray-800 transition-colors">
            <div class="flex items-center gap-3 mb-2">
              <span class="text-xs px-2 py-1 bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 rounded capitalize">${item.section}</span>
              <h2 class="font-semibold text-gray-900 dark:text-white group-hover:text-blue-600 dark:group-hover:text-blue-400 transition-colors">
                ${item.title}
              </h2>
            </div>
            <p class="text-sm text-gray-600 dark:text-gray-300 line-clamp-2">
              ${item.contents.substring(0, 200)}...
            </p>
          </a>
        </article>
      `;
    }).join('');
  });

  // Handle URL query parameter
  const urlParams = new URLSearchParams(window.location.search);
  const query = urlParams.get('q');
  if (query) {
    searchInput.value = query;
    searchInput.dispatchEvent(new Event('input'));
  }
})();
</script>
{{ end }}
